<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Content</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding: 24px;
        }

        .attack-section {
            background: rgb(255, 255, 255);
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .attack-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .attack-header:hover {
            background: #f9fafb;
        }

        .attack-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .expand-icon {
            transition: transform 0.2s;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .attack-details {
            display: none;
            padding: 24px;
        }

        .attack-details.expanded {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 4px 0 0 4px;
        }

        .metric-card.excellent::before { background: #10b981; }
        .metric-card.optimal::before { background: #10b981; }
        .metric-card.normal::before { background: #10b981; }
        .metric-card.online::before { background: #10b981; }
        .metric-card.operational::before { background: #10b981; }
        .metric-card.high::before { background: #f59e0b; }

        .metric-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .metric-status {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-card.excellent .metric-status { color: #10b981; }
        .metric-card.optimal .metric-status { color: #10b981; }
        .metric-card.normal .metric-status { color: #10b981; }
        .metric-card.online .metric-status { color: #10b981; }
        .metric-card.operational .metric-status { color: #10b981; }
        .metric-card.high .metric-status { color: #f59e0b; }

        /* DDoS Status Cards */
        .ddos-status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .ddos-status-card {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .ddos-status-card.normal {
            border-left: 4px solid #10b981;
        }

        .ddos-status-card.elevated {
            border-left: 4px solid #f59e0b;
        }

        .ddos-status-card.attack {
            border-left: 4px solid #ef4444;
        }

        .ddos-status-header {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ddos-rate {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .ddos-status-card.normal .ddos-rate { color: #10b981; }
        .ddos-status-card.elevated .ddos-rate { color: #f59e0b; }
        .ddos-status-card.attack .ddos-rate { color: #ef4444; }

        .ddos-description {
            font-size: 12px;
            color: #6b7280;
        }

        /* Timeline Section */
        .timeline-section {
            margin-bottom: 30px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .timeline-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: #6b7280;
        }

        .control-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #e5e7eb;
        }

        .control-btn.paused {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        /* Chart Container */
        .chart-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .chart-header {
            margin-bottom: 16px;
        }

        .legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .chart-canvas {
            width: 100%;
            height: 300px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }

        /* Live Feed */
        .live-feed {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .live-feed-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .feed-table {
            width: 100%;
            border-collapse: collapse;
        }

        .feed-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }

        .feed-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .feed-table tr:hover {
            background: #f9fafb;
        }

        .confidence-high {
            background: #fef2f2;
            color: #dc2626;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Log Tabs */
        .log-tabs {
            display: flex;
            gap: 4px;
            margin-right: 16px;
        }

        .log-tab {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #6b7280;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .log-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .log-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body>
    <!-- System Logs Section -->
    <div class="attack-section">
        <div class="attack-header" onclick="toggleSection('logs')">
            <div class="attack-title">System Logs</div>
            <div class="expand-icon" id="logs-icon">▶</div>
        </div>
        <div class="attack-details" id="logs-details">
            <!-- Log Statistics -->
            <div class="ddos-status-cards">
                <div class="ddos-status-card" id="totalLogsCard">
                    <div class="ddos-status-header">Total Logs</div>
                    <div class="ddos-rate" id="totalLogsValue">0</div>
                    <div class="ddos-description" id="totalLogsDescription">All log entries</div>
                </div>
                <div class="ddos-status-card" id="errorLogsCard">
                    <div class="ddos-status-header">Error Logs</div>
                    <div class="ddos-rate" id="errorLogsValue">0</div>
                    <div class="ddos-description" id="errorLogsDescription">Critical and error entries</div>
                </div>
                <div class="ddos-status-card" id="securityLogsCard">
                    <div class="ddos-status-header">Security Logs</div>
                    <div class="ddos-rate" id="securityLogsValue">0</div>
                    <div class="ddos-description" id="securityLogsDescription">Security-related events</div>
                </div>
            </div>

                   <!-- Log Tabs -->
                   <div class="timeline-section">
                       <div class="timeline-header">
                           <div class="timeline-title">Log Viewer</div>
                           <div class="timeline-controls">
                               <div class="log-tabs">
                                   <button class="log-tab active" onclick="switchLogTab('all')" id="tab-all">All Logs</button>
                                   <button class="log-tab" onclick="switchLogTab('ddos')" id="tab-ddos">DDoS</button>
                                   <button class="log-tab" onclick="switchLogTab('injection')" id="tab-injection">Injection</button>
                                   <button class="log-tab" onclick="switchLogTab('security')" id="tab-security">Security</button>
                               </div>
                               <select id="logTypeFilter" class="control-btn" style="padding: 6px 12px;">
                                   <option value="">All Types</option>
                                   <option value="system">System</option>
                                   <option value="security">Security</option>
                                   <option value="ddos">DDoS</option>
                                   <option value="injection">Injection</option>
                                   <option value="network">Network</option>
                                   <option value="api">API</option>
                               </select>
                               <select id="logLevelFilter" class="control-btn" style="padding: 6px 12px;">
                                   <option value="">All Levels</option>
                                   <option value="DEBUG">Debug</option>
                                   <option value="INFO">Info</option>
                                   <option value="WARNING">Warning</option>
                                   <option value="ERROR">Error</option>
                                   <option value="CRITICAL">Critical</option>
                               </select>
                               <button class="control-btn" onclick="refreshLogs()">
                                   <i class="fas fa-sync-alt"></i>
                                   Refresh
                               </button>
                               <button class="control-btn" onclick="exportLogs()">
                                   <i class="fas fa-download"></i>
                                   Export
                               </button>
                               <button class="control-btn" onclick="clearLogs()" style="background: #fee2e2; color: #dc2626;">
                                   <i class="fas fa-trash"></i>
                                   Clear
                               </button>
                           </div>
                       </div>
                   </div>

            <!-- Logs Table -->
            <div class="live-feed">
                <div class="live-feed-header">
                    <div class="live-indicator"></div>
                    <span style="font-weight: 600;">Recent Log Entries</span>
                </div>
                       <table class="feed-table">
                           <thead id="logsTableHeader">
                               <tr>
                                   <th>Timestamp</th>
                                   <th>Level</th>
                                   <th>Type</th>
                                   <th>Source</th>
                                   <th>Message</th>
                               </tr>
                           </thead>
                           <tbody id="logsTable">
                               <tr>
                                   <td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">Loading logs...</td>
                               </tr>
                           </tbody>
                       </table>
            </div>
        </div>
    </div>

    <!-- System Health Section -->
    <div class="attack-section">
        <div class="attack-header">
            <div class="attack-title">System Health</div>
        </div>
        <div class="attack-details expanded">
            <div class="metrics-grid">
                <div class="metric-card excellent">
                    <div class="metric-label">Detection Accuracy</div>
                    <div class="metric-value">96.8%</div>
                    <div class="metric-status">Excellent</div>
                </div>
                <div class="metric-card optimal">
                    <div class="metric-label">Response Time</div>
                    <div class="metric-value">1.2s</div>
                    <div class="metric-status">Optimal</div>
                </div>
                <div class="metric-card high">
                    <div class="metric-label">CPU Usage</div>
                    <div class="metric-value">78%</div>
                    <div class="metric-status">High</div>
                </div>
                <div class="metric-card normal">
                    <div class="metric-label">Memory Usage</div>
                    <div class="metric-value">62%</div>
                    <div class="metric-status">Normal</div>
                </div>
                <div class="metric-card online">
                    <div class="metric-label">Database</div>
                    <div class="metric-value">99.9%</div>
                    <div class="metric-status">Online</div>
                </div>
                <div class="metric-card operational">
                    <div class="metric-label">API Services</div>
                    <div class="metric-value">100%</div>
                    <div class="metric-status">Operational</div>
                </div>
            </div>
        </div>
    </div>

    <!-- DDoS Detection Dashboard Section -->
    <div class="attack-section">
        <div class="attack-header" onclick="toggleSection('ddos')">
            <div class="attack-title">DDoS Detection Dashboard</div>
            <div class="expand-icon" id="ddos-icon">▶</div>
        </div>
        <div class="attack-details" id="ddos-details">
            <!-- DDoS Service Status -->
            <div class="ddos-status-cards">
                <div class="ddos-status-card" id="ddosServiceCard">
                    <div class="ddos-status-header">LSTM DDoS Service</div>
                    <div class="ddos-rate" id="ddosServiceStatus">Loading...</div>
                    <div class="ddos-description" id="ddosServiceDescription">Initializing DDoS detection service</div>
                </div>
                <div class="ddos-status-card" id="modelStatusCard">
                    <div class="ddos-status-header">Model Status</div>
                    <div class="ddos-rate" id="modelStatusValue">Unknown</div>
                    <div class="ddos-description" id="modelStatusDescription">Checking model availability</div>
                </div>
                <div class="ddos-status-card" id="detectionStatsCard">
                    <div class="ddos-status-header">Detection Statistics</div>
                    <div class="ddos-rate" id="detectionStatsValue">0</div>
                    <div class="ddos-description" id="detectionStatsDescription">Total detections processed</div>
                </div>
            </div>

            <!-- Real-time Attack Probability Chart -->
            <div class="timeline-section">
                <div class="timeline-header">
                    <div class="timeline-title">Attack Probability Over Time</div>
                    <div class="timeline-controls">
                        <button class="control-btn" id="ddosPauseBtn" onclick="toggleDDoSUpdates()">
                            <span id="ddosPauseIcon">⏸</span>
                            <span id="ddosPauseText">Pause</span>
                        </button>
                        <span>Auto refresh: <span id="ddosRefreshRate">5s</span></span>
                    </div>
                        </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ef4444;"></div>
                                <span>Attack Probability</span>
                    </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f59e0b; border-style: dashed;"></div>
                                <span>Threshold (0.5)</span>
                        </div>
                    </div>
                </div>
                    <canvas class="chart-canvas" id="ddosAttackChart"></canvas>
                    </div>
                    </div>

            <!-- DDoS Alerts Table -->
            <div class="live-feed">
                <div class="live-feed-header">
                    <div class="live-indicator"></div>
                    <span style="font-weight: 600;">Recent DDoS Alerts</span>
                </div>
                <table class="feed-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Source IP</th>
                            <th>Probability</th>
                            <th>Intensity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ddosAlertsTable">
                        <tr>
                            <td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">No DDoS alerts detected</td>
                        </tr>
                    </tbody>
                </table>
                    </div>
                </div>
            </div>

    <!-- Injection Detection Dashboard Section -->
    <div class="attack-section">
        <div class="attack-header" onclick="toggleSection('injection')">
            <div class="attack-title">Injection Detection Dashboard</div>
            <div class="expand-icon" id="injection-icon">▶</div>
                    </div>
        <div class="attack-details" id="injection-details">
            <!-- Injection Service Status -->
            <div class="ddos-status-cards">
                <div class="ddos-status-card" id="injectionServiceCard">
                    <div class="ddos-status-header">Injection Detection Service</div>
                    <div class="ddos-rate" id="injectionServiceStatus">Loading...</div>
                    <div class="ddos-description" id="injectionServiceDescription">Initializing injection detection service</div>
                    </div>
                <div class="ddos-status-card" id="injectionModelCard">
                    <div class="ddos-status-header">Detection Engine</div>
                    <div class="ddos-rate" id="injectionModelValue">Unknown</div>
                    <div class="ddos-description" id="injectionModelDescription">Checking detection engine availability</div>
                    </div>
                <div class="ddos-status-card" id="injectionStatsCard">
                    <div class="ddos-status-header">Detection Statistics</div>
                    <div class="ddos-rate" id="injectionStatsValue">0</div>
                    <div class="ddos-description" id="injectionStatsDescription">Total injection attempts detected</div>
                </div>
                </div>

            <!-- Real-time Injection Detection Chart -->
            <div class="timeline-section">
                <div class="timeline-header">
                    <div class="timeline-title">Injection Attempts Over Time</div>
                    <div class="timeline-controls">
                        <button class="control-btn" id="injectionPauseBtn" onclick="toggleInjectionUpdates()">
                            <span id="injectionPauseIcon">⏸</span>
                            <span id="injectionPauseText">Pause</span>
                        </button>
                        <span>Auto refresh: <span id="injectionRefreshRate">5s</span></span>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #dc2626;"></div>
                                <span>SQL Injection</span>
            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ea580c;"></div>
                                <span>XSS</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #d97706;"></div>
                                <span>Command Injection</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #65a30d;"></div>
                                <span>Normal Traffic</span>
                            </div>
                        </div>
                    </div>
                    <canvas class="chart-canvas" id="injectionChart"></canvas>
        </div>
    </div>

            <!-- Injection Alerts Table -->
            <div class="live-feed">
                <div class="live-feed-header">
                    <div class="live-indicator"></div>
                    <span style="font-weight: 600;">Recent Injection Alerts</span>
                </div>
                <table class="feed-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Source IP</th>
                            <th>Attack Type</th>
                            <th>Confidence</th>
                            <th>Target</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="injectionAlertsTable">
                        <tr>
                            <td colspan="6" style="padding: 24px; text-align: center; color: #6b7280;">No injection alerts detected</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Health Section -->

    <script>
        // DDoS Dashboard variables
        let ddosChart = null;
        let ddosUpdateInterval = null;
        let ddosIsPaused = false;
        let ddosData = [];
        let ddosAlerts = [];

        // Injection Dashboard variables
        let injectionChart = null;
        let injectionUpdateInterval = null;
        let injectionIsPaused = false;
        let injectionData = [];
        let injectionAlerts = [];

        function toggleSection(sectionId) {
            const details = document.getElementById(sectionId + '-details');
            const icon = document.getElementById(sectionId + '-icon');
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.textContent = '▶';
            } else {
                details.classList.add('expanded');
                icon.classList.add('expanded');
                icon.textContent = '▼';
                
                if (sectionId === 'ddos' && !ddosChart) {
                    setTimeout(() => {
                        initializeDDoSChart();
                        loadDDoSStatus();
                        loadDDoSAlerts();
                        startDDoSUpdates();
                    }, 100);
                }
                
                if (sectionId === 'injection' && !injectionChart) {
                    setTimeout(() => {
                        initializeInjectionChart();
                        loadInjectionStatus();
                        loadInjectionAlerts();
                        startInjectionUpdates();
                    }, 100);
                }
                
                if (sectionId === 'logs') {
                    setTimeout(() => {
                        loadLogStatistics();
                        loadLogs();
                    }, 100);
                }
            }
        }

        // DDoS Dashboard Functions
        function initializeDDoSChart() {
            const canvas = document.getElementById('ddosAttackChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            ddosChart = {
                canvas: canvas,
                ctx: ctx,
                width: canvas.offsetWidth,
                height: canvas.offsetHeight,
                data: [],
                maxPoints: 50
            };
        }

        async function loadDDoSStatus() {
            try {
                const response = await fetch('http://localhost:5000/ddos/lstm/status');
                const data = await response.json();
                
                if (response.ok && data.available) {
                    updateDDoSStatusCards(data.statistics);
            } else {
                    updateDDoSStatusCards(null);
                }
            } catch (error) {
                console.error('Failed to load DDoS status:', error);
                updateDDoSStatusCards(null);
            }
        }

        function updateDDoSStatusCards(stats) {
            const serviceCard = document.getElementById('ddosServiceCard');
            const modelCard = document.getElementById('modelStatusCard');
            const statsCard = document.getElementById('detectionStatsCard');

            if (stats) {
                // Service Status
                serviceCard.className = 'ddos-status-card normal';
                document.getElementById('ddosServiceStatus').textContent = 'Running';
                document.getElementById('ddosServiceDescription').textContent = 'LSTM DDoS service is active';

                // Model Status
                const modelLoaded = stats.model_loaded ? 'Loaded' : 'Not Loaded';
                modelCard.className = stats.model_loaded ? 'ddos-status-card normal' : 'ddos-status-card elevated';
                document.getElementById('modelStatusValue').textContent = modelLoaded;
                document.getElementById('modelStatusDescription').textContent = `Device: ${stats.device || 'unknown'}`;

                // Detection Statistics
                statsCard.className = 'ddos-status-card normal';
                document.getElementById('detectionStatsValue').textContent = stats.total_detections || 0;
                document.getElementById('detectionStatsDescription').textContent = `Attack detections: ${stats.attack_detections || 0}`;
                } else {
                // Service unavailable
                serviceCard.className = 'ddos-status-card attack';
                document.getElementById('ddosServiceStatus').textContent = 'Stopped';
                document.getElementById('ddosServiceDescription').textContent = 'DDoS service unavailable';

                modelCard.className = 'ddos-status-card attack';
                document.getElementById('modelStatusValue').textContent = 'Unknown';
                document.getElementById('modelStatusDescription').textContent = 'Service not available';

                statsCard.className = 'ddos-status-card attack';
                document.getElementById('detectionStatsValue').textContent = '0';
                document.getElementById('detectionStatsDescription').textContent = 'No data available';
            }
        }

        async function loadDDoSAlerts() {
            try {
                const response = await fetch('http://localhost:5000/ddos/lstm/alerts');
                const data = await response.json();
                
                if (response.ok && data.alerts) {
                    ddosAlerts = data.alerts;
                    updateDDoSAlertsTable();
                }
            } catch (error) {
                console.error('Failed to load DDoS alerts:', error);
            }
        }

        function updateDDoSAlertsTable() {
            const tbody = document.getElementById('ddosAlertsTable');
            if (!tbody) return;
            
            if (ddosAlerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">No DDoS alerts detected</td></tr>';
                return;
            }
            
            tbody.innerHTML = ddosAlerts.map(alert => {
                const timestamp = new Date(alert.timestamp * 1000).toLocaleString();
                const probability = (alert.attack_probability * 100).toFixed(1);
                const intensity = (alert.attack_intensity * 100).toFixed(1);
                const status = alert.attack_probability > 0.5 ? 
                    '<span class="confidence-high">ATTACK</span>' : 
                    '<span style="color: #10b981; font-weight: 600;">NORMAL</span>';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td style="font-family: monospace;">${alert.source_ip}</td>
                        <td>${probability}%</td>
                        <td>${intensity}%</td>
                        <td>${status}</td>
                    </tr>
                `;
            }).join('');
        }

        function startDDoSUpdates() {
            ddosUpdateInterval = setInterval(async () => {
                if (!ddosIsPaused) {
                    await loadDDoSStatus();
                    await loadDDoSAlerts();
                    
                    // Add random data point for chart
                    if (ddosChart && Math.random() < 0.3) {
                        const probability = Math.random() * 0.3;
                        addDDoSDataPoint(probability);
                    }
                }
            }, 5000);
        }

        function addDDoSDataPoint(value) {
            if (!ddosChart) return;
            
            ddosChart.data.push({ value: value, timestamp: Date.now() });
            if (ddosChart.data.length > ddosChart.maxPoints) {
                ddosChart.data.shift();
            }
            drawDDoSChart();
        }

        function drawDDoSChart() {
            if (!ddosChart) return;
            
            const ctx = ddosChart.ctx;
            const width = ddosChart.width;
            const height = ddosChart.height;
            const padding = 50;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            if (ddosChart.data.length < 2) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', width / 2, height / 2);
                return;
            }
            
            // Draw axes
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
                ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
                ctx.stroke();
                
            // Draw threshold line
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            const thresholdY = height - padding - (0.5 * chartHeight);
            ctx.moveTo(padding, thresholdY);
            ctx.lineTo(width - padding, thresholdY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw data line
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const dataPoints = ddosChart.data.length;
            for (let i = 0; i < dataPoints; i++) {
                const x = padding + (i / (dataPoints - 1)) * chartWidth;
                const y = height - padding - (ddosChart.data[i].value * chartHeight);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Draw labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('0', padding - 20, height - padding + 4);
            ctx.fillText('0.5', padding - 20, thresholdY + 4);
            ctx.fillText('1.0', padding - 20, padding + 4);
        }

        function toggleDDoSUpdates() {
            const pauseBtn = document.getElementById('ddosPauseBtn');
            const pauseIcon = document.getElementById('ddosPauseIcon');
            const pauseText = document.getElementById('ddosPauseText');
            
            ddosIsPaused = !ddosIsPaused;
            
            if (ddosIsPaused) {
                pauseBtn.classList.add('paused');
                pauseIcon.textContent = '▶';
                pauseText.textContent = 'Resume';
            } else {
                pauseBtn.classList.remove('paused');
                pauseIcon.textContent = '⏸';
                pauseText.textContent = 'Pause';
            }
        }

        // Injection Dashboard Functions
        function initializeInjectionChart() {
            const canvas = document.getElementById('injectionChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            injectionChart = {
                canvas: canvas,
                ctx: ctx,
                width: canvas.offsetWidth,
                height: canvas.offsetHeight,
                data: [],
                maxPoints: 50
            };
        }

        async function loadInjectionStatus() {
            try {
                const response = await fetch('http://localhost:5000/monitor/stats');
                const data = await response.json();
                
                if (response.ok) {
                    updateInjectionStatusCards(data);
            } else {
                    updateInjectionStatusCards(null);
                }
            } catch (error) {
                console.error('Failed to load injection status:', error);
                updateInjectionStatusCards(null);
            }
        }

        function updateInjectionStatusCards(stats) {
            const serviceCard = document.getElementById('injectionServiceCard');
            const modelCard = document.getElementById('injectionModelCard');
            const statsCard = document.getElementById('injectionStatsCard');

            if (stats) {
                // Service Status
                serviceCard.className = 'ddos-status-card normal';
                document.getElementById('injectionServiceStatus').textContent = 'Running';
                document.getElementById('injectionServiceDescription').textContent = 'Injection detection service is active';

                // Model Status
                const detectorAvailable = stats.detector_available ? 'Available' : 'Not Available';
                modelCard.className = stats.detector_available ? 'ddos-status-card normal' : 'ddos-status-card elevated';
                document.getElementById('injectionModelValue').textContent = detectorAvailable;
                document.getElementById('injectionModelDescription').textContent = `Threshold: ${stats.detection_threshold || 0.5}`;

                // Detection Statistics
                statsCard.className = 'ddos-status-card normal';
                document.getElementById('injectionStatsValue').textContent = stats.injection_attempts_detected || 0;
                document.getElementById('injectionStatsDescription').textContent = `Total requests: ${stats.total_requests_monitored || 0}`;
            } else {
                // Service unavailable
                serviceCard.className = 'ddos-status-card attack';
                document.getElementById('injectionServiceStatus').textContent = 'Stopped';
                document.getElementById('injectionServiceDescription').textContent = 'Injection service unavailable';

                modelCard.className = 'ddos-status-card attack';
                document.getElementById('injectionModelValue').textContent = 'Unknown';
                document.getElementById('injectionModelDescription').textContent = 'Service not available';

                statsCard.className = 'ddos-status-card attack';
                document.getElementById('injectionStatsValue').textContent = '0';
                document.getElementById('injectionStatsDescription').textContent = 'No data available';
            }
        }

        async function loadInjectionAlerts() {
            try {
                const response = await fetch('http://localhost:5000/monitor/alerts');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    injectionAlerts = data;
                    updateInjectionAlertsTable();
                }
            } catch (error) {
                console.error('Failed to load injection alerts:', error);
            }
        }

        function updateInjectionAlertsTable() {
            const tbody = document.getElementById('injectionAlertsTable');
            if (!tbody) return;
            
            if (injectionAlerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 24px; text-align: center; color: #6b7280;">No injection alerts detected</td></tr>';
                return;
            }
            
            tbody.innerHTML = injectionAlerts.map(alert => {
                const timestamp = new Date(alert.timestamp).toLocaleString();
                const confidence = (alert.confidence * 100).toFixed(1);
                const attackType = alert.attack_type || 'Unknown';
                const status = alert.confidence > 0.5 ? 
                    '<span class="confidence-high">ATTACK</span>' : 
                    '<span style="color: #10b981; font-weight: 600;">NORMAL</span>';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td style="font-family: monospace;">${alert.source_ip || 'Unknown'}</td>
                        <td>${attackType}</td>
                        <td>${confidence}%</td>
                        <td>${alert.endpoint || 'Unknown'}</td>
                        <td>${status}</td>
                    </tr>
                `;
            }).join('');
        }

        function startInjectionUpdates() {
            injectionUpdateInterval = setInterval(async () => {
                if (!injectionIsPaused) {
                    await loadInjectionStatus();
                    await loadInjectionAlerts();
                    
                    // Add random data point for chart
                    if (injectionChart && Math.random() < 0.2) {
                        const attackTypes = ['sql', 'xss', 'command', 'normal'];
                        const attackType = attackTypes[Math.floor(Math.random() * attackTypes.length)];
                        addInjectionDataPoint(attackType);
                    }
                }
            }, 5000);
        }

        function addInjectionDataPoint(attackType) {
            if (!injectionChart) return;
            
            injectionChart.data.push({ 
                type: attackType, 
                timestamp: Date.now(),
                value: Math.random() * 0.8 + 0.1
            });
            if (injectionChart.data.length > injectionChart.maxPoints) {
                injectionChart.data.shift();
            }
            drawInjectionChart();
        }

        function drawInjectionChart() {
            if (!injectionChart) return;
            
            const ctx = injectionChart.ctx;
            const width = injectionChart.width;
            const height = injectionChart.height;
            const padding = 50;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            if (injectionChart.data.length < 2) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', width / 2, height / 2);
                return;
            }
            
            // Draw axes
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
                ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
                ctx.stroke();
            
            // Draw data points
            const colors = {
                'sql': '#dc2626',
                'xss': '#ea580c',
                'command': '#d97706',
                'normal': '#65a30d'
            };
            
            const dataPoints = injectionChart.data.length;
            for (let i = 0; i < dataPoints; i++) {
                const point = injectionChart.data[i];
                const x = padding + (i / (dataPoints - 1)) * chartWidth;
                const y = height - padding - (point.value * chartHeight);
                
                ctx.fillStyle = colors[point.type] || '#6b7280';
            ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // Draw labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('0', padding - 20, height - padding + 4);
            ctx.fillText('0.5', padding - 20, height - padding - chartHeight/2 + 4);
            ctx.fillText('1.0', padding - 20, padding + 4);
        }

        function toggleInjectionUpdates() {
            const pauseBtn = document.getElementById('injectionPauseBtn');
            const pauseIcon = document.getElementById('injectionPauseIcon');
            const pauseText = document.getElementById('injectionPauseText');
            
            injectionIsPaused = !injectionIsPaused;
            
            if (injectionIsPaused) {
                pauseBtn.classList.add('paused');
                pauseIcon.textContent = '▶';
                pauseText.textContent = 'Resume';
            } else {
                pauseBtn.classList.remove('paused');
                pauseIcon.textContent = '⏸';
                pauseText.textContent = 'Pause';
            }
        }

        // Logs Functions
        async function loadLogStatistics() {
            try {
                const response = await fetch('http://localhost:5000/logs/statistics');
                const data = await response.json();
                
                if (response.ok) {
                    updateLogStatistics(data);
                } else {
                    console.error('Failed to load log statistics:', data.error);
                }
            } catch (error) {
                console.error('Error loading log statistics:', error);
            }
        }

        function updateLogStatistics(stats) {
            // Update total logs
            document.getElementById('totalLogsValue').textContent = stats.total_logs || 0;
            
            // Update error logs (ERROR + CRITICAL)
            const errorCount = (stats.by_level?.ERROR || 0) + (stats.by_level?.CRITICAL || 0);
            document.getElementById('errorLogsValue').textContent = errorCount;
            
            // Update security logs
            const securityCount = stats.by_type?.security || 0;
            document.getElementById('securityLogsValue').textContent = securityCount;
            
            // Update card colors based on counts
            const totalCard = document.getElementById('totalLogsCard');
            const errorCard = document.getElementById('errorLogsCard');
            const securityCard = document.getElementById('securityLogsCard');
            
            totalCard.className = 'ddos-status-card normal';
            errorCard.className = errorCount > 0 ? 'ddos-status-card elevated' : 'ddos-status-card normal';
            securityCard.className = securityCount > 0 ? 'ddos-status-card elevated' : 'ddos-status-card normal';
        }

        async function loadLogs() {
            try {
                const typeFilter = document.getElementById('logTypeFilter').value;
                const levelFilter = document.getElementById('logLevelFilter').value;
                
                let url, data;
                
                // Load logs based on current tab
                switch (currentLogTab) {
                    case 'ddos':
                        url = 'http://localhost:5000/logs/ddos?limit=100';
                        const ddosResponse = await fetch(url);
                        data = await ddosResponse.json();
                        if (ddosResponse.ok) {
                            updateDDoSLogsTable(data.ddos_logs || []);
                        } else {
                            console.error('Failed to load DDoS logs:', data.error);
                        }
                        return;
                        
                    case 'injection':
                        url = 'http://localhost:5000/logs/injection?limit=100';
                        const injectionResponse = await fetch(url);
                        data = await injectionResponse.json();
                        if (injectionResponse.ok) {
                            updateInjectionLogsTable(data.injection_logs || []);
                        } else {
                            console.error('Failed to load injection logs:', data.error);
                        }
                        return;
                        
                    case 'security':
                        url = 'http://localhost:5000/logs/security?limit=100';
                        const securityResponse = await fetch(url);
                        data = await securityResponse.json();
                        if (securityResponse.ok) {
                            updateSecurityLogsTable(data.security_logs || []);
                        } else {
                            console.error('Failed to load security logs:', data.error);
                        }
                        return;
                        
                    default: // 'all'
                        url = 'http://localhost:5000/logs?limit=100';
                        if (typeFilter) url += `&type=${typeFilter}`;
                        if (levelFilter) url += `&level=${levelFilter}`;
                        
                        const response = await fetch(url);
                        data = await response.json();
                        
                        if (response.ok) {
                            updateLogsTable(data.logs || []);
                        } else {
                            console.error('Failed to load logs:', data.error);
                        }
                        break;
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function updateLogsTable(logs) {
            const tbody = document.getElementById('logsTable');
            if (!tbody) return;
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">No logs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => {
                const timestamp = new Date(log.timestamp * 1000).toLocaleString();
                const level = log.level;
                const levelClass = level === 'ERROR' || level === 'CRITICAL' ? 'confidence-high' : 
                                 level === 'WARNING' ? 'style="color: #f59e0b; font-weight: 600;"' : 
                                 'style="color: #10b981; font-weight: 600;"';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td><span ${levelClass}>${level}</span></td>
                        <td>${log.log_type}</td>
                        <td style="font-family: monospace;">${log.source}</td>
                        <td>${log.message}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateDDoSLogsTable(logs) {
            const tbody = document.getElementById('logsTable');
            if (!tbody) return;
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 24px; text-align: center; color: #6b7280;">No DDoS logs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => {
                const timestamp = new Date(log.timestamp * 1000).toLocaleString();
                const level = log.level;
                const levelClass = level === 'ERROR' || level === 'CRITICAL' ? 'confidence-high' : 
                                 level === 'WARNING' ? 'style="color: #f59e0b; font-weight: 600;"' : 
                                 'style="color: #10b981; font-weight: 600;"';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td><span ${levelClass}>${level}</span></td>
                        <td>${log.source_ip}</td>
                        <td>${log.attack_type}</td>
                        <td>${(log.confidence * 100).toFixed(1)}%</td>
                        <td>${log.severity}</td>
                        <td>${log.request_count}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateInjectionLogsTable(logs) {
            const tbody = document.getElementById('logsTable');
            if (!tbody) return;
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 24px; text-align: center; color: #6b7280;">No injection logs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => {
                const timestamp = new Date(log.timestamp * 1000).toLocaleString();
                const level = log.level;
                const levelClass = level === 'ERROR' || level === 'CRITICAL' ? 'confidence-high' : 
                                 level === 'WARNING' ? 'style="color: #f59e0b; font-weight: 600;"' : 
                                 'style="color: #10b981; font-weight: 600;"';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td><span ${levelClass}>${level}</span></td>
                        <td>${log.source_ip}</td>
                        <td>${log.attack_type}</td>
                        <td>${(log.confidence * 100).toFixed(1)}%</td>
                        <td>${log.endpoint}</td>
                        <td>${log.payload.substring(0, 50)}${log.payload.length > 50 ? '...' : ''}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateSecurityLogsTable(logs) {
            const tbody = document.getElementById('logsTable');
            if (!tbody) return;
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 24px; text-align: center; color: #6b7280;">No security logs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => {
                const timestamp = new Date(log.timestamp * 1000).toLocaleString();
                const level = log.level;
                const levelClass = level === 'ERROR' || level === 'CRITICAL' ? 'confidence-high' : 
                                 level === 'WARNING' ? 'style="color: #f59e0b; font-weight: 600;"' : 
                                 'style="color: #10b981; font-weight: 600;"';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td><span ${levelClass}>${level}</span></td>
                        <td>${log.source_ip}</td>
                        <td>${log.event_type}</td>
                        <td>${log.threat_level}</td>
                        <td>${log.endpoint}</td>
                    </tr>
                `;
            }).join('');
        }

        function refreshLogs() {
            loadLogStatistics();
            loadLogs();
        }

        async function exportLogs() {
            try {
                const typeFilter = document.getElementById('logTypeFilter').value;
                const levelFilter = document.getElementById('logLevelFilter').value;
                
                let url = 'http://localhost:5000/logs/export?limit=1000';
                if (typeFilter) url += `&type=${typeFilter}`;
                if (levelFilter) url += `&level=${levelFilter}`;
                
                const response = await fetch(url);
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `logs_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    alert('Failed to export logs');
                }
            } catch (error) {
                console.error('Error exporting logs:', error);
                alert('Error exporting logs');
            }
        }

        async function clearLogs() {
            if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                try {
                    const response = await fetch('http://localhost:5000/logs/clear', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        alert('Logs cleared successfully');
                        refreshLogs();
                    } else {
                        alert('Failed to clear logs');
                    }
                } catch (error) {
                    console.error('Error clearing logs:', error);
                    alert('Error clearing logs');
                }
            }
        }

        // Log tab switching
        let currentLogTab = 'all';

        function switchLogTab(tab) {
            currentLogTab = tab;
            
            // Update tab appearance
            document.querySelectorAll('.log-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Update table headers
            updateTableHeaders(tab);
            
            // Load appropriate logs
            loadLogs();
        }

        function updateTableHeaders(tab) {
            const header = document.getElementById('logsTableHeader');
            if (!header) return;
            
            let headers;
            switch (tab) {
                case 'ddos':
                    headers = ['Timestamp', 'Level', 'Source IP', 'Attack Type', 'Confidence', 'Severity', 'Request Count'];
                    break;
                case 'injection':
                    headers = ['Timestamp', 'Level', 'Source IP', 'Attack Type', 'Confidence', 'Endpoint', 'Payload'];
                    break;
                case 'security':
                    headers = ['Timestamp', 'Level', 'Source IP', 'Event Type', 'Threat Level', 'Endpoint'];
                    break;
                default: // 'all'
                    headers = ['Timestamp', 'Level', 'Type', 'Source', 'Message'];
                    break;
            }
            
            header.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        }

        // Add event listeners for filter changes
        document.addEventListener('DOMContentLoaded', function() {
            const typeFilter = document.getElementById('logTypeFilter');
            const levelFilter = document.getElementById('logLevelFilter');
            
            if (typeFilter) {
                typeFilter.addEventListener('change', loadLogs);
            }
            if (levelFilter) {
                levelFilter.addEventListener('change', loadLogs);
            }
        });

        window.addEventListener('resize', function() {
            if (ddosChart) {
                initializeDDoSChart();
                drawDDoSChart();
            }
            if (injectionChart) {
                initializeInjectionChart();
                drawInjectionChart();
            }
        });
    </script>
</body>
</html>
